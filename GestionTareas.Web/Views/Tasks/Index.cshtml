@model Response<List<TaskEntityDTO?>>
@{
    var search = Context.Request.Query["search"].ToString();
    var startDate = Context.Request.Query["startDate"].ToString();
    var endDate = Context.Request.Query["endDate"].ToString();
    var status = Context.Request.Query["status"].ToString();
}



<!-- 2. Contenido Principal -->
<div class="container-fluid p-4">
    <div class="row justify-content-center">

        <!-- Columna para el Listado de Tareas -->
        <div class="col-12 col-lg-8 task-list-container">
            <h1 class="mb-4 text-primary fw-bold">Listado de Tareas</h1>
            
            <!--  Formulario de búsqueda y filtros -->
            <form asp-action="Index" method="get" class="card p-3 mb-4 shadow-sm">
                <div class="row g-3 align-items-end">

                    <!-- Buscar por texto -->
                    <div class="col-md-4">
                        <label for="search" class="form-label fw-semibold">Buscar</label>
                        <input type="text" id="search" name="search" value="@search"
                               class="form-control" placeholder="Título o descripción..." />
                    </div>

                    <!-- Fecha inicial -->
                    <div class="col-md-3">
                        <label for="startDate" class="form-label fw-semibold">Desde</label>
                        <input type="date" id="startDate" name="startDate" value="@startDate"
                               class="form-control" />
                    </div>

                    <!-- Fecha final -->
                    <div class="col-md-3">
                        <label for="endDate" class="form-label fw-semibold">Hasta</label>
                        <input type="date" id="endDate" name="endDate" value="@endDate"
                               class="form-control" />
                    </div>

                    <!-- Estado -->
                    <div class="col-md-2">
                        <label for="status" class="form-label fw-semibold">Estado</label>
                        <!-- Usamos !<select> para evitar la interferencia del Tag Helper -->
                        <!select id="status" name="status" class="form-select">
                            <!option value="">Todos</!option>
                            <!option value="true" @(status == "true" ? "selected" : null)>Completadas</!option>
                            <!option value="false" @(status == "false" ? "selected" : null)>Pendientes</!option>
                        </!select>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-3 gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-1"></i> Buscar
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-repeat me-1"></i> Limpiar
                    </a>
                </div>
            </form>



            <!-- Listado de Tareas -->
            @if (Model?.Result != null && Model.Result.Any())
            {
                <ul class="list-group list-group-flush list-group-shadow">

                    @foreach (var task in Model.Result)
                    {
                        // Determina si la tarea está completada para aplicar clases de estilo
                        var isCompleted = task.Status;
                        var taskClass = isCompleted ? "task-completed" : "list-group-item-light";
                        var buttonIcon = isCompleted ? "bi-check-circle-fill" : "bi-circle";
                        var buttonStyle = isCompleted ? "btn-success" : "btn-outline-primary";
                        var newStatus = isCompleted ? "false" : "true";

                        <li class="list-group-item p-3 @taskClass rounded-3 mb-2">
                            <div
                                class="d-flex justify-content-between align-items-start align-items-md-center flex-column flex-md-row">

                                <!-- Contenido de la Tarea (Título, Descripción, Fecha) -->
                                <div class="flex-grow-1 me-md-3 mb-2 mb-md-0">
                                    <div class="d-flex align-items-center">
                                        <h5 class="mb-0 fw-bold task-title me-3 @(isCompleted ? "text-decoration-line-through text-secondary" : "text-dark")">
                                            @task?.Title
                                        </h5>
                                        <!-- Badge para la Fecha de Entrega -->
                                        <span class="badge rounded-pill bg-primary-subtle text-primary fw-normal">
                                                Vence: @task?.Finished.ToString("dd/MM/yyyy")
                                            </span>
                                    </div>
                                    <p class="mb-0 mt-1 small text-muted">
                                        @task?.Description
                                    </p>
                                </div>

                                <!-- Acciones (Botones de Estado) -->
                                <div class="d-flex align-items-center">

                                    <!-- Botón de Completar/Pendiente -->
                                    <form asp-action="Toggle" method="POST" style="display:inline;" class="me-2">
                                        <input type="hidden" name="TaskId" value="@task.Id"/>
                                        <input type="hidden" name="Status" value="@newStatus"/>
                                        <button type="submit" class="btn btn-sm @buttonStyle"
                                                title="@(isCompleted ? "Marcar como Pendiente" : "Completar Tarea")">
                                            <i class="bi @buttonIcon"></i>
                                            <span
                                                class="d-none d-sm-inline-block ms-1">@(isCompleted ? "Completada" : "Pendiente")</span>
                                        </button>
                                    </form>

                                    <!-- Botón de Eliminar/Editar (Placeholders) -->
                                    <a asp-action="Edit" asp-route-Id="@task.Id"
                                       class="btn btn-sm btn-outline-secondary me-2" title="Editar Tarea">
                                        <i class="bi bi-pencil"></i>
                                    </a>

                                    <form asp-action="Delete" asp-route-Id="@task.Id" style="display: contents">
                                        <button cla class="btn btn-sm btn-outline-danger btnDelete"
                                                title="Eliminar Tarea">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <div class="alert alert-info text-center mt-5" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    ¡Felicitaciones! No hay tareas pendientes. Usa el botón flotante para agregar una.
                </div>
            }

        </div> <!-- Fin de la Columna Principal -->
    </div>
</div>

<!-- 3. Botón de Acción Flotante (FAB) para Agregar Tarea (GET form) -->
<!-- Asumo que tu acción GET para añadir tarea es 'Create' -->
<a asp-action="Create" class="btn btn-success floating-action-button" title="Añadir Nueva Tarea">
    <i class="bi bi-plus-lg"></i>
</a>

@section Scripts{
    <script>
        $(document).ready(function () {
            $('.btnDelete').click(function (event) {
                event.preventDefault();
                Swal.fire({
                    title: "¿Eliminar sección?",
                    text: "No podrá revertirlo",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Eliminar",
                    cancelButtonText: "Cancelar"
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: "Eliminado!",
                            icon: "success"
                        });
                        const form = $(this).closest('form');
                        form.submit();
                    }
                });
            });
        });
    </script>
}